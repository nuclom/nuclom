---
title: "Backend API Integration"
description: "Backend API architecture with Effect-TS, Drizzle ORM, and Better-Auth"
icon: "server"
---

This document describes the backend API integration implemented for the Nuclom video collaboration platform.

## Overview

The backend integration includes:

- Database schema and models using Drizzle ORM + PostgreSQL
- API routes for CRUD operations
- Authentication with better-auth
- AI integration with OpenAI
- File storage with Cloudflare R2

## Database Schema

### Core Models

| Model | Description |
| ----- | ----------- |
| **User** | User accounts and profiles |
| **Organization** | Team organizations for collaboration |
| **Video** | Video content with metadata |
| **Channel** | Organized video channels |
| **Series** | Video series/playlists |
| **Comment** | Video comments and discussions |
| **VideoProgress** | User viewing progress tracking |

### Relationships

- Users belong to multiple organizations
- Videos belong to organizations, channels, and series
- Comments are threaded and belong to videos
- Progress tracking per user per video

## API Endpoints

<Tabs>
  <Tab title="Videos">
    | Method | Endpoint | Description |
    | ------ | -------- | ----------- |
    | GET | `/api/videos` | List videos with filtering |
    | GET | `/api/videos/[id]` | Get video with details |
    | POST | `/api/videos` | Create new video |
    | PUT | `/api/videos/[id]` | Update video |
    | DELETE | `/api/videos/[id]` | Delete video |
  </Tab>
  <Tab title="Organizations">
    | Method | Endpoint | Description |
    | ------ | -------- | ----------- |
    | GET | `/api/organizations` | List user organizations |
    | POST | `/api/organizations` | Create organization |
  </Tab>
  <Tab title="Authentication">
    | Method | Endpoint | Description |
    | ------ | -------- | ----------- |
    | POST | `/api/auth/[...better-auth]` | Authentication endpoints |

    Supports email/password and OAuth (GitHub, Google)
  </Tab>
  <Tab title="AI Services">
    | Method | Endpoint | Description |
    | ------ | -------- | ----------- |
    | POST | `/api/ai/analyze` | Generate summaries and extract action items |
  </Tab>
</Tabs>

## Data Fetching

### React Hooks

- `useVideos()` - Fetch videos with filtering
- `useVideo(id)` - Fetch single video with details
- `useOrganizations()` - Fetch user organizations

### API Client

- Type-safe API client with error handling
- Automatic loading and error states
- Mock data fallback during development

## Development Setup

<Steps>
  <Step title="Database Setup">
    ```bash
    # Copy environment variables
    cp .env.example .env.local

    # Add your database URL
    DATABASE_URL="postgresql://..."

    # Run Drizzle migrations
    pnpm db:generate
    pnpm db:migrate
    ```
  </Step>
  <Step title="Authentication Setup">
    ```bash
    # Add auth secrets to .env.local
    BETTER_AUTH_SECRET="your-secret"
    GITHUB_CLIENT_ID="..."
    GITHUB_CLIENT_SECRET="..."
    ```
  </Step>
  <Step title="AI Integration">
    ```bash
    # Add Replicate API token for video transcription
    REPLICATE_API_TOKEN="r8_..."
    ```
  </Step>
</Steps>

## API Route Patterns

### Dynamic Route Rendering

<Warning>
**Important**: API routes that access the database or require authentication must call `await connection()` at the start of the handler to prevent static generation during builds.
</Warning>

```typescript
import { connection, type NextRequest, NextResponse } from "next/server";
import { db } from "@/lib/db";

export async function GET(request: NextRequest) {
  await connection(); // Required: prevents static generation

  // Your route logic here...
  const data = await db.query.videos.findMany();
  return NextResponse.json(data);
}
```

**Why this is needed**: Next.js attempts to statically generate API routes during the build process. Routes that access databases, require authentication, or need request-specific data will fail during static generation because these resources aren't available at build time.

<Note>
Do NOT use `export const dynamic = "force-dynamic"` as this pattern no longer works correctly on Vercel deployments. The `await connection()` pattern is the recommended approach.
</Note>

### Effect-TS Routes

For routes using Effect-TS, add `await connection()` before running the Effect:

```typescript
import { Effect } from "effect";
import { connection, type NextRequest, NextResponse } from "next/server";

export async function GET(request: NextRequest) {
  await connection(); // Required: prevents static generation

  const effect = Effect.gen(function* () {
    // Your Effect logic here...
  });

  const runnable = Effect.provide(effect, AppLive);
  const exit = await Effect.runPromiseExit(runnable);
  return handleEffectExit(exit);
}
```

## Production Deployment

<AccordionGroup>
  <Accordion title="Database">
    - Use Xata, Supabase, or PlanetScale for PostgreSQL hosting
    - Set DATABASE_URL environment variable
    - Run migrations: `pnpm db:migrate`
  </Accordion>
  <Accordion title="File Storage">
    - Configure Cloudflare R2 credentials
    - Update file upload endpoints to use R2
  </Accordion>
  <Accordion title="Authentication">
    - Set production OAuth app credentials
    - Enable email verification for production
  </Accordion>
</AccordionGroup>

## Type Safety

All API responses and database models are fully typed:

- Drizzle generates database types
- API responses use `ApiResponse<T>` wrapper
- React hooks provide typed data and loading states

## Error Handling

- API routes return standardized error responses
- Client-side hooks handle loading and error states
- Graceful fallbacks for offline/error scenarios

## Related Documentation

<CardGroup cols={2}>
  <Card title="Effect-TS" href="/internal/architecture/effect-ts" icon="code">
    Type-safe error handling patterns
  </Card>
  <Card title="Database Schema" href="/internal/architecture/database" icon="database">
    Full schema documentation
  </Card>
  <Card title="Authentication" href="/internal/architecture/authentication" icon="lock">
    Better-Auth configuration
  </Card>
  <Card title="Video Processing" href="/internal/architecture/video-processing" icon="video">
    Processing pipeline
  </Card>
</CardGroup>
