---
title: "Security Architecture"
description: "Security features and best practices for the Nuclom platform"
icon: "shield-halved"
---

This document describes the security features and best practices implemented in the Nuclom platform.

## Rate Limiting

The platform implements comprehensive rate limiting to protect against abuse.

### Storage Backend

<Tabs>
  <Tab title="Redis (Upstash)">
    Recommended for production:
    - Distributed rate limiting across all server instances
    - Persistent across deployments
    - Uses Upstash's sliding window algorithm
    - Requires `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN`
  </Tab>
  <Tab title="In-Memory">
    Fallback for development:
    - Per-instance rate limiting
    - Used automatically when Redis is not configured
    - State lost on restart
  </Tab>
</Tabs>

### Configuration

Rate limits are configured in `src/lib/rate-limit.ts` and applied via Next.js middleware:

| Endpoint Type | Requests | Window | Use Case |
|---------------|----------|--------|----------|
| General API | 100 | 1 minute | Standard API endpoints |
| Authentication | 10 | 15 minutes | Login, signup, sign-out |
| Sensitive Operations | 5 | 1 hour | Password reset, account deletion |
| File Uploads | 20 | 1 hour | Video and file uploads |

### Response Headers

All API responses include rate limit information:

- `X-RateLimit-Limit`: Maximum requests allowed
- `X-RateLimit-Remaining`: Requests remaining in current window
- `X-RateLimit-Reset`: Unix timestamp when the window resets

<Note>
When rate limited, endpoints return HTTP 429 with a `Retry-After` header.
</Note>

### Usage

```typescript
// Sync version (for middleware, uses in-memory)
import { rateLimit, rateLimitAuth } from "@/lib/rate-limit";

export async function POST(request: NextRequest) {
  const rateLimitResult = rateLimitAuth(request);
  if (rateLimitResult) return rateLimitResult;
  // ... handle request
}

// Async version (for API routes, uses Redis when available)
import { rateLimitAsync, rateLimitAuthAsync } from "@/lib/rate-limit";

export async function POST(request: NextRequest) {
  const rateLimitResult = await rateLimitAuthAsync(request);
  if (rateLimitResult) return rateLimitResult;
  // ... handle request
}
```

## Security Headers

Security headers are configured in `next.config.ts` and applied to all routes:

| Header | Value | Purpose |
|--------|-------|---------|
| Content-Security-Policy | Strict CSP | Prevents XSS and injection attacks |
| X-Frame-Options | SAMEORIGIN | Prevents clickjacking |
| X-Content-Type-Options | nosniff | Prevents MIME type sniffing |
| Referrer-Policy | strict-origin-when-cross-origin | Controls referrer information |
| Permissions-Policy | Restrictive policy | Limits browser features |
| X-XSS-Protection | 1; mode=block | XSS protection for older browsers |

### Content Security Policy

The CSP is configured to:
- Allow scripts from self only (with unsafe-inline for Next.js)
- Allow styles from self and inline (for CSS-in-JS)
- Allow images from trusted domains (GitHub, Google, Gravatar, Cloudflare R2)
- Allow connections to self, Stripe, and R2 storage
- Prevent embedding in iframes (except same-origin)
- Upgrade insecure requests in production

## Session Security

Session security is handled by better-auth's built-in features and plugins.

### Session Tracking

Sessions automatically track IP address and user agent, which can be viewed by users in their account settings.

### Concurrent Session Limits

The `multiSession` plugin limits users to a maximum of 5 concurrent sessions:

```typescript
// Configured in auth.ts
multiSession({
  maximumSessions: 5,
});
```

When a new session is created and the limit is exceeded, the oldest sessions are automatically revoked.

### Session Revocation on Password Change

```typescript
// Client-side usage
await authClient.changePassword({
  currentPassword: "...",
  newPassword: "...",
  revokeOtherSessions: true, // Revokes all other sessions
});
```

### Secure Cookie Settings

```typescript
advanced: {
  cookiePrefix: "nuclom",
  useSecureCookies: env.NODE_ENV === "production",
  defaultCookieAttributes: {
    httpOnly: true,           // Prevents JavaScript access
    secure: true,             // HTTPS only in production
    sameSite: "lax",          // CSRF protection
    path: "/",
  },
}
```

## CORS Configuration

CORS is strictly configured in `src/lib/auth.ts`:

- **Production**: Only the main app URL is trusted
- **Preview deployments**: Vercel preview URLs are allowed (non-production only)
- **Development**: localhost is allowed

## API Endpoints

### Session Management

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/user/sessions` | GET | List all active sessions |
| `/api/user/sessions` | DELETE | Revoke all sessions except current |

Password changes with session revocation are handled via better-auth's `/api/auth/change-password` endpoint.

## Enterprise Security Features

### SSO/SAML Integration

Enterprise organizations can configure Single Sign-On using SAML 2.0 or OIDC protocols.

<Tabs>
  <Tab title="SAML Configuration">
    ```typescript
    {
      providerType: "saml",
      entityId: "https://idp.example.com/entity",
      ssoUrl: "https://idp.example.com/sso",
      sloUrl: "https://idp.example.com/slo",
      certificate: "-----BEGIN CERTIFICATE-----...",
      autoProvision: true,
      defaultRole: "member",
      allowedDomains: ["example.com"]
    }
    ```
  </Tab>
  <Tab title="OIDC Configuration">
    ```typescript
    {
      providerType: "oidc",
      issuer: "https://auth.example.com",
      clientId: "your-client-id",
      clientSecret: "your-client-secret",
      discoveryUrl: "https://auth.example.com/.well-known/openid-configuration"
    }
    ```
  </Tab>
</Tabs>

#### SSO API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/organizations/:id/sso` | GET | Get SSO configuration |
| `/api/organizations/:id/sso` | POST | Configure SSO |
| `/api/organizations/:id/sso` | PATCH | Enable/disable SSO |
| `/api/organizations/:id/sso` | DELETE | Delete SSO configuration |

### Advanced RBAC

Granular permission system supporting custom roles and resource-level permissions.

#### Permission Model

<CardGroup cols={2}>
  <Card title="Resources" icon="folder">
    video, channel, collection, comment, member, settings, billing, analytics, integration, audit_log
  </Card>
  <Card title="Actions" icon="hand-pointer">
    create, read, update, delete, share, comment, download, manage, invite, admin
  </Card>
</CardGroup>

#### System Roles

| Role | Description | Key Permissions |
|------|-------------|-----------------|
| Owner | Full control | All permissions including billing |
| Admin | Administrative access | All except billing admin |
| Editor | Content management | Create, edit, share content |
| Viewer | Read-only access | View content, add comments |

#### RBAC API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/organizations/:id/roles` | GET | List all roles |
| `/api/organizations/:id/roles` | POST | Create custom role |
| `/api/organizations/:id/roles/:roleId` | GET | Get role details |
| `/api/organizations/:id/roles/:roleId` | PATCH | Update role |
| `/api/organizations/:id/roles/:roleId` | DELETE | Delete role |
| `/api/organizations/:id/members/:userId/permissions` | GET | Get user permissions |
| `/api/organizations/:id/members/:userId/permissions` | POST | Assign role |
| `/api/organizations/:id/members/:userId/permissions` | DELETE | Remove role |

### Comprehensive Audit Logging

All security-relevant actions are logged for compliance and forensics.

#### Log Categories

<AccordionGroup>
  <Accordion title="authentication">
    Login, logout, password changes, 2FA events
  </Accordion>
  <Accordion title="authorization">
    Permission grants, role assignments
  </Accordion>
  <Accordion title="user_management">
    User creation, updates, deletion
  </Accordion>
  <Accordion title="organization_management">
    Member changes, settings updates
  </Accordion>
  <Accordion title="content_management">
    Video/channel/collection CRUD operations
  </Accordion>
  <Accordion title="billing">
    Subscription and payment events
  </Accordion>
  <Accordion title="security">
    Session revocation, suspicious activity
  </Accordion>
  <Accordion title="integration">
    Third-party service connections
  </Accordion>
</AccordionGroup>

#### Log Severity Levels

| Level | Description |
|-------|-------------|
| `info` | Normal operations |
| `warning` | Potential issues (failed logins, rate limits) |
| `error` | Operation failures |
| `critical` | Security incidents requiring immediate attention |

#### Audit Log API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/organizations/:id/audit-logs` | GET | Query audit logs |
| `/api/organizations/:id/audit-logs` | POST | Request export |
| `/api/organizations/:id/audit-logs/stats` | GET | Get statistics |
| `/api/organizations/:id/audit-logs/exports/:exportId` | GET | Check export status |

#### Export Formats

<CardGroup cols={2}>
  <Card title="CSV" icon="file-csv">
    For spreadsheet analysis
  </Card>
  <Card title="JSON" icon="file-code">
    For programmatic processing
  </Card>
</CardGroup>

## Best Practices

<Warning>
**Critical Security Practices:**

1. **Always use HTTPS in production** - The `secure` cookie flag enforces this
2. **Monitor rate limit violations** - Potential abuse indicator
3. **Review session activity** - Users can view and revoke sessions in settings
4. **Rotate secrets regularly** - Update `BETTER_AUTH_SECRET` periodically
5. **Keep dependencies updated** - Security patches for auth libraries
</Warning>

## Related Files

```
src/lib/rate-limit.ts           # Rate limiting implementation
src/lib/redis.ts                # Redis client configuration
src/lib/auth.ts                 # Authentication configuration
src/lib/access-control.ts       # RBAC configuration
src/lib/audit-log.ts            # Audit logging service
src/middleware.ts               # Next.js middleware
next.config.ts                  # Security headers
src/app/api/user/sessions/      # Session management API
src/app/api/organizations/[id]/sso/        # SSO configuration API
src/app/api/organizations/[id]/roles/      # RBAC roles API
src/app/api/organizations/[id]/audit-logs/ # Audit logs API
```
