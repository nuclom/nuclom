name: E2E Tests

# This workflow is triggered by e2e-trigger.yml when Vercel deployments are ready
# It can also be triggered manually via workflow_dispatch for testing specific URLs
#
# With Vercel's "Skip Unaffected Projects" enabled, not all apps may be deployed.
# This workflow conditionally runs tests based on which apps were deployed.

on:
  workflow_dispatch:
    inputs:
      saas_url:
        description: "SaaS deployment URL (optional if test_saas is false)"
        required: false
        type: string
      marketing_url:
        description: "Marketing deployment URL (optional if test_marketing is false)"
        required: false
        type: string
      test_saas:
        description: "Whether to run SaaS tests (default: true)"
        required: false
        type: string
        default: "true"
      test_marketing:
        description: "Whether to run Marketing tests (default: true)"
        required: false
        type: string
        default: "true"
      triggered_by_sha:
        description: "Commit SHA that triggered this run (set by e2e-trigger.yml)"
        required: false
        type: string

env:
  CI: true

permissions:
  contents: read
  deployments: read
  statuses: write

# Use SHA-based concurrency when triggered by e2e-trigger.yml to prevent duplicate runs
# Falls back to ref-based for manual triggers
concurrency:
  group: e2e-${{ github.event.inputs.triggered_by_sha || github.sha }}
  cancel-in-progress: true

jobs:
  # Job to determine which tests should run
  determine-tests:
    name: Determine Tests
    runs-on: ubuntu-latest
    outputs:
      run_saas: ${{ steps.check.outputs.run_saas }}
      run_marketing: ${{ steps.check.outputs.run_marketing }}
      skip_all: ${{ steps.check.outputs.skip_all }}

    steps:
      - name: Check which tests to run
        id: check
        run: |
          TEST_SAAS="${{ github.event.inputs.test_saas }}"
          TEST_MARKETING="${{ github.event.inputs.test_marketing }}"
          SAAS_URL="${{ github.event.inputs.saas_url }}"
          MARKETING_URL="${{ github.event.inputs.marketing_url }}"

          # Default to true for manual triggers without explicit test flags
          if [ -z "$TEST_SAAS" ]; then
            TEST_SAAS="true"
          fi
          if [ -z "$TEST_MARKETING" ]; then
            TEST_MARKETING="true"
          fi

          # Determine if we should run each test suite
          RUN_SAAS="false"
          RUN_MARKETING="false"

          if [ "$TEST_SAAS" = "true" ] && [ -n "$SAAS_URL" ]; then
            RUN_SAAS="true"
          fi

          if [ "$TEST_MARKETING" = "true" ] && [ -n "$MARKETING_URL" ]; then
            RUN_MARKETING="true"
          fi

          # Check if all tests are skipped
          SKIP_ALL="false"
          if [ "$RUN_SAAS" = "false" ] && [ "$RUN_MARKETING" = "false" ]; then
            SKIP_ALL="true"
          fi

          echo "run_saas=$RUN_SAAS" >> $GITHUB_OUTPUT
          echo "run_marketing=$RUN_MARKETING" >> $GITHUB_OUTPUT
          echo "skip_all=$SKIP_ALL" >> $GITHUB_OUTPUT

          echo "Test configuration:"
          echo "  Run SaaS tests: $RUN_SAAS"
          echo "  Run Marketing tests: $RUN_MARKETING"
          echo "  Skip all: $SKIP_ALL"

  # Job that passes when all tests are skipped (for required checks)
  skip-check:
    name: Playwright (Skipped)
    runs-on: ubuntu-latest
    needs: determine-tests
    if: needs.determine-tests.outputs.skip_all == 'true'

    steps:
      - name: Report skipped status
        run: |
          echo "All E2E tests skipped - no apps were deployed"
          echo "This is expected when Vercel's 'Skip Unaffected Projects' skips all builds"

      - name: Set commit status to success (skipped)
        if: ${{ github.event.inputs.triggered_by_sha }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.inputs.triggered_by_sha }}',
              state: 'success',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'E2E tests skipped (no apps deployed)',
              context: 'E2E Tests / Playwright'
            });

  e2e-tests:
    name: Playwright (${{ matrix.shard }}/3)
    runs-on: ubuntu-latest
    needs: determine-tests
    if: needs.determine-tests.outputs.skip_all == 'false'
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]

    steps:
      - name: Set commit status to pending
        if: ${{ github.event.inputs.triggered_by_sha && matrix.shard == 1 }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.inputs.triggered_by_sha }}',
              state: 'pending',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'E2E tests are running...',
              context: 'E2E Tests / Playwright'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # When triggered by e2e-trigger.yml, checkout the specific commit SHA
          # that was deployed. For manual triggers, use the default behavior.
          ref: ${{ github.event.inputs.triggered_by_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-pw-1.57-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        run: pnpm --filter @nuclom/e2e exec playwright install chromium chromium-headless-shell --with-deps

      - name: Log test configuration
        run: |
          echo "Test Configuration:"
          echo "  SaaS URL: ${{ github.event.inputs.saas_url || '(not deployed)' }}"
          echo "  Marketing URL: ${{ github.event.inputs.marketing_url || '(not deployed)' }}"
          echo "  Run SaaS tests: ${{ needs.determine-tests.outputs.run_saas }}"
          echo "  Run Marketing tests: ${{ needs.determine-tests.outputs.run_marketing }}"
          echo "  Shard: ${{ matrix.shard }}/3"
          echo "  Triggered by SHA: ${{ github.event.inputs.triggered_by_sha || '(manual trigger)' }}"

      - name: Run SaaS E2E tests
        if: needs.determine-tests.outputs.run_saas == 'true'
        run: pnpm test:saas --shard=${{ matrix.shard }}/3
        working-directory: tests/e2e
        env:
          SAAS_BASE_URL: ${{ github.event.inputs.saas_url }}
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}
          E2E_TEST_ORG: e2e-tests
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

      - name: Run Marketing E2E tests
        if: needs.determine-tests.outputs.run_marketing == 'true'
        run: pnpm test:marketing --shard=${{ matrix.shard }}/3
        working-directory: tests/e2e
        env:
          MARKETING_BASE_URL: ${{ github.event.inputs.marketing_url }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}-shard-${{ matrix.shard }}
          path: tests/e2e/playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}-shard-${{ matrix.shard }}
          path: tests/e2e/test-results/
          retention-days: 14

      - name: Notify Vercel status
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: "Vercel - nuclom-saas: E2E Tests"

      - name: Set commit status to success/failure
        if: ${{ always() && github.event.inputs.triggered_by_sha && matrix.shard == 1 }}
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const runSaas = '${{ needs.determine-tests.outputs.run_saas }}' === 'true';
            const runMarketing = '${{ needs.determine-tests.outputs.run_marketing }}' === 'true';

            let description;
            if (state === 'success') {
              const parts = [];
              if (runSaas) parts.push('SaaS');
              if (runMarketing) parts.push('Marketing');
              description = `E2E tests passed (${parts.join(' + ')})`;
            } else {
              description = 'E2E tests failed';
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.inputs.triggered_by_sha }}',
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'E2E Tests / Playwright'
            });
