name: E2E Trigger

# Triggered by Vercel repository_dispatch events when deployments complete
# This workflow coordinates between SaaS and Marketing deployments
# and triggers E2E tests when deployments are ready
#
# With "Skip Unaffected Projects" enabled in Vercel, not all apps will be built
# on every commit. This workflow uses Turborepo's --dry-run to detect which apps
# will be built and only waits for those deployments.
#
# NOTE: repository_dispatch events only trigger workflows on the default branch.
# The workflow will still checkout the correct commit SHA for testing.
#
# See: https://github.com/vercel/repository-dispatch

on:
  repository_dispatch:
    types:
      # Deployment automatically promoted to production
      - "vercel.deployment.success"
      # Build finished, awaiting promotion (preview deployments)
      - "vercel.deployment.ready"
      # Deployment skipped due to "Skip Unaffected Projects" setting
      - "vercel.deployment.skipped"

# No concurrency limit - each deployment event runs independently.
# Whichever deployment finishes second will see both URLs ready and trigger E2E.
# E2E workflow has its own SHA-based concurrency to prevent duplicate test runs.

jobs:
  trigger-e2e:
    name: Check Deployments
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: read
      actions: write # Required to trigger e2e.yml via workflow_dispatch

    steps:
      - name: Log deployment event
        run: |
          echo "Received Vercel deployment event"
          echo "  Event type: ${{ github.event.action }}"
          echo "  Project: ${{ github.event.client_payload.project.name }}"
          echo "  URL: ${{ github.event.client_payload.url || '(skipped/none)' }}"
          echo "  Environment: ${{ github.event.client_payload.environment }}"
          echo "  Git SHA: ${{ github.event.client_payload.git.sha }}"
          echo "  Git Ref: ${{ github.event.client_payload.git.ref }}"
          if [ "${{ github.event.action }}" = "vercel.deployment.skipped" ]; then
            echo "  Note: This deployment was skipped by Vercel (no changes affected this project)"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.git.sha }}
          fetch-depth: 2 # Need parent commit for turbo comparison

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect affected apps with Turborepo
        id: turbo-check
        run: |
          echo "Checking which apps are affected by this commit..."

          # Use turbo build --dry-run to detect affected packages
          # Compare against HEAD~1 to see what changed in this commit
          SAAS_AFFECTED="false"
          MARKETING_AFFECTED="false"

          # Check if saas app is affected
          SAAS_DRY=$(pnpm turbo build --filter=nuclom-saas --dry-run=json 2>/dev/null || echo '{"packages":[]}')
          if echo "$SAAS_DRY" | grep -q '"nuclom-saas"'; then
            # Further check if there are actual tasks to run (not all cached)
            SAAS_TASKS=$(echo "$SAAS_DRY" | jq -r '.tasks | length // 0')
            if [ "$SAAS_TASKS" -gt 0 ]; then
              SAAS_AFFECTED="true"
            fi
          fi

          # Check if marketing app is affected
          MARKETING_DRY=$(pnpm turbo build --filter=nuclom-marketing --dry-run=json 2>/dev/null || echo '{"packages":[]}')
          if echo "$MARKETING_DRY" | grep -q '"nuclom-marketing"'; then
            MARKETING_TASKS=$(echo "$MARKETING_DRY" | jq -r '.tasks | length // 0')
            if [ "$MARKETING_TASKS" -gt 0 ]; then
              MARKETING_AFFECTED="true"
            fi
          fi

          echo "Turborepo analysis:"
          echo "  SaaS affected: $SAAS_AFFECTED"
          echo "  Marketing affected: $MARKETING_AFFECTED"

          echo "saas_affected=$SAAS_AFFECTED" >> $GITHUB_OUTPUT
          echo "marketing_affected=$MARKETING_AFFECTED" >> $GITHUB_OUTPUT

      - name: Check deployments and trigger E2E
        uses: actions/github-script@v7
        env:
          SAAS_AFFECTED: ${{ steps.turbo-check.outputs.saas_affected }}
          MARKETING_AFFECTED: ${{ steps.turbo-check.outputs.marketing_affected }}
        with:
          script: |
            const payload = context.payload.client_payload;
            const sha = payload.git.sha;
            const currentUrl = payload.url;
            const projectName = payload.project.name;
            const gitRef = payload.git.ref;
            const eventType = context.payload.action;
            const isSkipped = eventType === 'vercel.deployment.skipped';

            // Get Turborepo analysis results
            const expectSaas = process.env.SAAS_AFFECTED === 'true';
            const expectMarketing = process.env.MARKETING_AFFECTED === 'true';

            // Identify deployment type from project name
            const isSaas = projectName.includes('nuclom-saas') || projectName === 'nuclom-saas';
            const isMarketing = projectName.includes('nuclom-marketing') || projectName === 'nuclom-marketing';

            if (!isSaas && !isMarketing) {
              console.log(`Ignoring deployment for project: ${projectName}`);
              return;
            }

            console.log(`Processing ${isSaas ? 'nuclom-saas' : 'nuclom-marketing'} deployment`);
            console.log(`  SHA: ${sha}`);
            console.log(`  URL: ${currentUrl || '(none)'}`);
            console.log(`  Event: ${eventType}${isSkipped ? ' (deployment was skipped by Vercel)' : ''}`);

            console.log(`Expected deployments (from Turborepo):`);
            console.log(`  SaaS: ${expectSaas ? 'expected' : 'skipped (no changes)'}`);
            console.log(`  Marketing: ${expectMarketing ? 'expected' : 'skipped (no changes)'}`);

            // Helper to check all deployment statuses for this SHA
            // Returns URLs for successful deployments and flags for skipped ones
            async function checkDeployments() {
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                per_page: 20
              });

              let saasUrl = null;
              let marketingUrl = null;
              let saasSkipped = false;
              let marketingSkipped = false;

              for (const deployment of deployments) {
                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  per_page: 1
                });

                if (statuses.length > 0) {
                  const status = statuses[0];
                  const statusUrl = status.environment_url || status.target_url;
                  const isSaasDeployment = statusUrl?.includes('nuclom-saas') || deployment.environment?.includes('nuclom-saas');
                  const isMarketingDeployment = statusUrl?.includes('nuclom-marketing') || deployment.environment?.includes('nuclom-marketing');

                  if (status.state === 'success') {
                    if (isSaasDeployment) saasUrl = statusUrl;
                    if (isMarketingDeployment) marketingUrl = statusUrl;
                  } else if (status.state === 'inactive') {
                    // Deployment was skipped by Vercel
                    if (isSaasDeployment) saasSkipped = true;
                    if (isMarketingDeployment) marketingSkipped = true;
                  }
                }
              }

              return { saasUrl, marketingUrl, saasSkipped, marketingSkipped };
            }

            // Helper to trigger E2E workflow
            async function triggerE2E(saasUrl, marketingUrl, testSaas, testMarketing) {
              // Use git ref from deployment, fallback to default branch
              const ref = gitRef || context.payload.repository.default_branch;

              console.log(`Triggering E2E workflow`);
              console.log(`  Ref: ${ref}`);
              console.log(`  SaaS URL: ${saasUrl || '(skipped)'}`);
              console.log(`  Marketing URL: ${marketingUrl || '(skipped)'}`);
              console.log(`  Test SaaS: ${testSaas}`);
              console.log(`  Test Marketing: ${testMarketing}`);

              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e.yml',
                ref: ref,
                inputs: {
                  saas_url: saasUrl || '',
                  marketing_url: marketingUrl || '',
                  test_saas: String(testSaas),
                  test_marketing: String(testMarketing),
                  triggered_by_sha: sha
                }
              });

              console.log('E2E workflow triggered successfully');
            }

            // Initial check - include the URL from the current event
            let { saasUrl, marketingUrl, saasSkipped, marketingSkipped } = await checkDeployments();

            // The current event's URL might not be in GitHub's deployment API yet,
            // so add it manually based on the project type
            if (isSaas) {
              if (isSkipped) {
                saasSkipped = true;
              } else if (!saasUrl && currentUrl) {
                saasUrl = currentUrl;
              }
            } else if (isMarketing) {
              if (isSkipped) {
                marketingSkipped = true;
              } else if (!marketingUrl && currentUrl) {
                marketingUrl = currentUrl;
              }
            }

            console.log(`Current deployment status:`);
            console.log(`  SaaS: ${saasUrl || (saasSkipped ? 'skipped by Vercel' : 'not ready')}`);
            console.log(`  Marketing: ${marketingUrl || (marketingSkipped ? 'skipped by Vercel' : 'not ready')}`);

            // Check if all expected deployments are ready (either have URL or were skipped)
            // A deployment is "ready" if:
            // 1. Turborepo says it's not affected (expectSaas/expectMarketing is false), OR
            // 2. It has a deployment URL (saasUrl/marketingUrl), OR
            // 3. It was skipped by Vercel (saasSkipped/marketingSkipped)
            const saasReady = !expectSaas || saasUrl || saasSkipped;
            const marketingReady = !expectMarketing || marketingUrl || marketingSkipped;

            // Determine if we should actually run tests for each app
            // Only run tests if the app was expected AND has a URL (not skipped)
            const shouldTestSaas = expectSaas && saasUrl && !saasSkipped;
            const shouldTestMarketing = expectMarketing && marketingUrl && !marketingSkipped;

            if (saasReady && marketingReady) {
              console.log('All expected deployments ready, triggering E2E tests');
              await triggerE2E(saasUrl, marketingUrl, shouldTestSaas, shouldTestMarketing);
              return;
            }

            // Not all expected deployments are ready - wait for the other deployment's event
            if (!saasReady) {
              console.log('Waiting for SaaS deployment event...');
            }
            if (!marketingReady) {
              console.log('Waiting for Marketing deployment event...');
            }
